#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
#
# jar (v0.2.0)
#
# A script to simplify jar and uberjar builds.
#
# Usage:
#  jar path/to/output.jar  [uber?]

path=$1
uber=$2
cmd=(clojure)

# Use local deps when running on Drone
drone="${DRONE:0}"
if [ "true" == "${drone}" ]; then
    echo "Running on Drone. Using local .deps directory."
    cmd+=(-Sdeps '{:mvn/local-repo ".deps"}' -A:jar)
else
    cmd+=(-A:jar)
fi

# What kind of jar to build
if [ "true" == "${uber}" ]; then
    cmd+=(-m hf.depstar.uberjar)
else
    cmd+=(-m hf.depstar.jar)
fi

# Path
if [ -z "${path}" ]; then
    echo -e "You must provide an output path. Usage:\n\tjar path [uber?]"
    exit 1
fi
cmd+=("${path}")

echo ${cmd[*]} && "${cmd[@]}"


# For uberjars, we need the manifest to make executable
if [ "true" == "${uber}" ]; then
    echo "Creating manifest for ${path}"
    echo 'Main-Class: clojure.main' > /tmp/manifest
    jar ufm $path /tmp/manifest
fi
